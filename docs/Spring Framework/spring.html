<!doctype html>
<html lang="fr" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Spring Framework/spring" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">Spring Security : Authentification et Autorisation avec JWT | ON APPREND SANS CESSE</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://mossaabfrifita.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://mossaabfrifita.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://mossaabfrifita.github.io/docs/Spring Framework/spring"><meta data-rh="true" property="og:locale" content="fr"><meta data-rh="true" name="docusaurus_locale" content="fr"><meta data-rh="true" name="docsearch:language" content="fr"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring Security : Authentification et Autorisation avec JWT | ON APPREND SANS CESSE"><meta data-rh="true" name="description" content="Cet article est un retour d’expérience sur l&#x27;intégration de Spring Security dans une application Java basée sur Spring Boot."><meta data-rh="true" property="og:description" content="Cet article est un retour d’expérience sur l&#x27;intégration de Spring Security dans une application Java basée sur Spring Boot."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://mossaabfrifita.github.io/docs/Spring Framework/spring"><link data-rh="true" rel="alternate" href="https://mossaabfrifita.github.io/docs/Spring Framework/spring" hreflang="fr"><link data-rh="true" rel="alternate" href="https://mossaabfrifita.github.io/docs/Spring Framework/spring" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ea9770ca.css">
<script src="/assets/js/runtime~main.afe266ae.js" defer="defer"></script>
<script src="/assets/js/main.0cd224c4.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Aller au contenu principal"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Aller au contenu principal</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Ouvrir/fermer la barre de navigation" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/custom-logo.jpg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/custom-logo.jpg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Mossaab Frifita</b></a><a class="navbar__item navbar__link" href="/docs/category/devops-cicd-pipeline">DevOps</a><a class="navbar__item navbar__link" href="/docs/category/spring-framework">Spring</a><a class="navbar__item navbar__link" href="/docs/category/angular">Angular</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/MossaabFrifita" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-label="Basculer entre le mode sombre et clair (actuellement mode clair)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Retour au début de la page" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/devops-cicd-pipeline">DevOps CI/CD pipeline</a><button aria-label="Développer la catégorie &#x27;DevOps CI/CD pipeline&#x27; de la barre latérale" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/spring-framework">Spring Framework</a><button aria-label="Réduire la catégorie &#x27;Spring Framework&#x27; de la barre latérale" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Spring Framework/spring">Spring Security : Authentification et Autorisation avec JWT</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/angular">Angular</a><button aria-label="Développer la catégorie &#x27;Angular&#x27; de la barre latérale" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Fil d&#x27;Ariane"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Page d&#x27;accueil" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/spring-framework"><span itemprop="name">Spring Framework</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring Security : Authentification et Autorisation avec JWT</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">Sur cette page</button></div><div class="theme-doc-markdown markdown"><h1>Spring Security : Authentification et Autorisation avec JWT</h1>
<p>Cet article est un retour d’expérience sur l&#x27;intégration de Spring Security dans une application Java basée sur Spring Boot.</p>
<p>Cet article n&#x27;est pas une formation ou un cours complet de Spring Security, mais plutôt un guide visant à vous aider à mettre en place une authentification basée sur JWT (JSON WEB TOKEN). Il couvre certains aspects nécessaires de la sécurité informatique, ainsi que des définitions et des principes qui vous aideront à vous familiariser avec Spring Security.</p>
<p>Dans cet article, nous allons créer un exemple concret d&#x27;API REST basé sur Spring boot qui couvre les bases essentielles d&#x27;authentification et d&#x27;autorisation en Spring Security avec JWT.</p>
<p>Spring Security est un Framework qui offre une couche de sécurité pour les applications Java Spring, en particulier avec Spring Boot. Il permet de configurer Spring pour prévenir les attaques en ayant recours à très peu, voire à aucune configuration.</p>
<p>La sécurité des applications Web de manière générale est très importante et à ne pas négliger, en tant que développeur informatique, il est essentiel d&#x27;avoir un minimum de compétences en matière de sécurité pour garantir la protection des données sensibles.</p>
<h1>Définitions et concepts de bases</h1>
<p>Notre objectif est de contrôler l&#x27;accès à une API REST Spring Boot en mettant en place un mécanisme de sécurité. Le contrôle d&#x27;accès comprend généralement deux étapes distinctes : l&#x27;authentification et l&#x27;autorisation.</p>
<p>Nous allons faire appel à Spring Security pour controler l&#x27;accès à notre API, mais voyons d&#x27;abord la différence entre l&#x27;authentification et l&#x27;autorisation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="focus-sur-lauthentification">Focus sur l&#x27;authentification<a href="#focus-sur-lauthentification" class="hash-link" aria-label="Lien direct vers Focus sur l&#x27;authentification" title="Lien direct vers Focus sur l&#x27;authentification">​</a></h2>
<p>L&#x27;utilisateur doit être authentifié avant d&#x27;accéder aux différentes ressources de l&#x27;application. Il existe plusieurs manières de faire l&#x27;authentification dans notre cas, nous devons mettre en place un mécanisme permettant de fournir à l&#x27;utilisateur une clé d&#x27;authentification, qu&#x27;il devra présenter à chaque interaction avec le serveur nécessitant un accès sécurisé.</p>
<p>Il existe différentes formes d&#x27;authentification, dont l&#x27;authentification basique basée sur le login et le mot de passe. Pour notre future API REST, nous allons choisir une approche <strong>Stateless</strong>, où l&#x27;API n&#x27;enregistrera pas l&#x27;état de l&#x27;utilisateur entre les requêtes. Cependant, il est important de noter que d&#x27;autres applications peuvent utiliser un système d&#x27;authentification <strong>Stateful</strong>, où l&#x27;état de l&#x27;utilisateur est conservé entre les requêtes, par exemple en utilisant des sessions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentification-stateful">Authentification Stateful<a href="#authentification-stateful" class="hash-link" aria-label="Lien direct vers Authentification Stateful" title="Lien direct vers Authentification Stateful">​</a></h3>
<p>L&#x27;authentification <strong>Stateful</strong> repose sur l&#x27;utilisation de sessions, qui représentent une période de temps pendant laquelle un utilisateur est authentifié et peut interagir avec le site. Lorsque l&#x27;utilisateur se connecte pour la première fois via son navigateur en utilisant ses identifiants, le serveur ouvre une session avec un ID unique et une durée de validité pour représenter l&#x27;utilisateur connecté. Pour maintenir l&#x27;état de la session côté client, le serveur envoie un cookie contenant l&#x27;identifiant de session au navigateur de l&#x27;utilisateur. Le navigateur stocke ensuite ce cookie et l&#x27;envoie automatiquement au serveur avec chaque requête ultérieure pour maintenir la continuité de la session.</p>
<p>Lorsque le serveur reçoit une requête avec le cookie, il fait la correspondance entre l&#x27;identifiant de session et les données de session associées. Cela lui permet de vérifier si l&#x27;utilisateur est toujours authentifié et si la session est toujours valide.</p>
<p>Ce qu&#x27;il faut retenir de tout ça :</p>
<p>Si les données de la session sont enregistrés côté serveur d&#x27;authentification et qu&#x27;une copie est enregistrée côté client sous forme de cookies , alors cela correspond à une authentification de type <strong>Stateful.</strong> Cette approche permet de maintenir un état de session du côté du serveur.</p>
<p>Ce type d&#x27;authentification ne sera pas implémenté dans cet article.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentification-stateless">Authentification Stateless<a href="#authentification-stateless" class="hash-link" aria-label="Lien direct vers Authentification Stateless" title="Lien direct vers Authentification Stateless">​</a></h3>
<p>L&#x27;API n&#x27;a pas besoin de maintenir la session côté serveur. Comme mentionné précédemment, les données de session sont enregistrées dans un jeton d&#x27;authentification qui est envoyé au client une fois qu&#x27;il est correctement authentifié. Le client utilise ensuite ce jeton pour l&#x27;associer à chaque requête envoyée au serveur. Cela correspond à une authentification de type Stateless.</p>
<p>Il n&#x27;est pas nécessaire de stocker le jeton côté serveur. Nous explorerons plus en détail ultérieurement comment le serveur peut vérifier et valider ce jeton d&#x27;accès.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="focus-sur-lautorisation">Focus sur l&#x27;autorisation<a href="#focus-sur-lautorisation" class="hash-link" aria-label="Lien direct vers Focus sur l&#x27;autorisation" title="Lien direct vers Focus sur l&#x27;autorisation">​</a></h2>
<p>L&#x27;autorisation est basée sur les rôles, ce qui signifie qu&#x27;après l&#x27;authentification, nous pouvons contrôler qui a le droit d&#x27;effectuer certaines tâches. Par exemple, un utilisateur administrateur peut accéder et modifier les données, tandis qu&#x27;un utilisateur visiteur ne peut que les lire. Il est important de souligner que cette autorisation peut être plus granulaire, permettant de définir les droits de lecture sur des données spécifiques plutôt que sur l&#x27;ensemble des données.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lutilisation-dun-jwt">L’utilisation d’un JWT<a href="#lutilisation-dun-jwt" class="hash-link" aria-label="Lien direct vers L’utilisation d’un JWT" title="Lien direct vers L’utilisation d’un JWT">​</a></h2>
<p>Un JSON Web Token (JWT) est en effet un objet JSON qui contient des paires clé-valeur. Il est généralement encodé et représenté sous forme d&#x27;une chaîne de caractères. Dans le contexte de l&#x27;authentification, un JWT peut contenir des informations telles qu&#x27;un username, une liste de droits d&#x27;accès et une date d&#x27;expiration. Lorsqu&#x27;un JWT contenant ces informations est inclus dans une requête, il est possible d&#x27;indiquer à Spring Security d&#x27;utiliser ce JWT comme preuve d&#x27;authentification.</p>
<p>Le JWT encapsule les informations de session de l&#x27;utilisateur ainsi que d&#x27;autres informations supplémentaires. Pour structurer ces informations, le JWT est composé de trois parties distinctes (header, payload, signature) qui sont encodées en base64URL et séparées par des points (.) :</p>
<ol>
<li>
<p><strong>Header</strong> : c&#x27;est la première partie d&#x27;un JWT, elle contient des informations sur le type de jeton et l&#x27;algorithme de signature utilisé : &quot;alg&quot; : l&#x27;algorithme de signature utilisé pour signer le jeton &quot;typ&quot; : le type de jeton</p>
</li>
<li>
<p><strong>Payload</strong> : contient les revendications appelées &quot;Claims&quot; qui représentent les informations spécifiques à l&#x27;utilisateur et aux métadonnées supplémentaires. Il existe trois type de revendications :</p>
<p><strong>Revendications enregistrées (Registered Claims)</strong> : Ce sont des revendications prédéfinies par le standard JWT qui ne sont pas obligatoires, mais recommandées pour représenter des informations couramment utilisées. Par exemple, &quot;iss&quot; (émetteur), &quot;sub&quot; (sujet), &quot;exp&quot; (date d&#x27;expiration) et &quot;iat&quot; (date de création).</p>
<p><strong>Revendications privées (Private Claims)</strong> : Ce sont des revendications personnalisées définies par l&#x27;émetteur et le destinataire du jeton pour échanger des informations spécifiques à leur application.</p>
<p><strong>Revendications publiques (Public Claims)</strong> : Ce sont des revendications personnalisées qui sont définies dans des registres publics pour assurer l&#x27;interopérabilité entre différentes applications.</p>
</li>
<li>
<p><strong>Signature</strong> : la signature est utilisée pour garantir que le jeton n&#x27;a pas été modifié par des tiers non autorisés. La signature est calculée en utilisant le Header + les Claims encodées en Base64Url + une clé secrète (dans le cas d&#x27;un algorithme de signature symétrique) ou une paire de clés (dans le cas d&#x27;un algorithme de signature asymétrique).</p>
</li>
</ol>
<p>La signature est ajoutée en tant que troisième partie du JWT, également encodée en Base64Url.</p>
<p>En résumé, la combinaison de ces trois parties <strong>Header.Payload.Signature</strong> forme le JWT. Voici un exemple :</p>
<p><img decoding="async" loading="lazy" alt="image-20230716224835601" src="/assets/images/image-20230716224835601-64e04e4b81d22e0af4e6a80484e75c8e.png" width="510" height="175" class="img_ev3q"></p>
<p>Cette structure permet de transporter les informations nécessaires de manière sécurisée et compacte dans le JWT, sans avoir besoin de stocker des informations de session côté serveur.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lutilisation-dun-refreshtoken">L&#x27;utilisation d&#x27;un refreshToken<a href="#lutilisation-dun-refreshtoken" class="hash-link" aria-label="Lien direct vers L&#x27;utilisation d&#x27;un refreshToken" title="Lien direct vers L&#x27;utilisation d&#x27;un refreshToken">​</a></h2>
<p>Le JWT a une durée de validité relativement courte, pour garantir une sécurité maximale, Cependant s&#x27;il est expiré l&#x27;utilisateur doit s&#x27;authentifier à nouveau et donc re saisir son login et son mot de passe pour demander un autre JWT. Le refreshToken vient résoudre ce problème, il peut être utilisé pour demander un nouveau jeton d&#x27;accès sans nécessiter de nouvelles informations d&#x27;identification de la part de l&#x27;utilisateur.</p>
<p>Le refreshToken est tout simplement un jeton de rafraichissement qui a une durée de validité plus longue que le jeton d&#x27;accès. Il est utilisé spécifiquement pour obtenir un nouveau jeton d&#x27;accès lorsque le jeton actuel expire. Le jeton de rafraîchissement est généralement associé à une session utilisateur persistante et est stocké de manière sécurisée côté serveur.</p>
<p>Voici comment nous allons mettons cela en pratique :</p>
<ol>
<li>Lorsque l&#x27;utilisateur se connecte et réussit l&#x27;authentification, le serveur génère un jeton d&#x27;accès et un jeton de rafraîchissement et les envoie au client(application ou service) et le jeton de rafraîchissement est stocké côté serveur.</li>
<li>Lorsque le jeton d&#x27;accès expire, au lieu de demander à l&#x27;utilisateur de se reconnecter avec ses informations d&#x27;identification, le client envoie le jeton de rafraîchissement au serveur.</li>
<li>Le serveur vérifie si le jeton de rafraîchissement est valide et correspond à un utilisateur connecté. Si c&#x27;est le cas, le serveur génère un nouveau jeton d&#x27;accès avec une durée de validité limitée et le renvoie au client.</li>
<li>Le client utilise alors ce nouveau jeton d&#x27;accès pour accéder aux ressources protégées.</li>
</ol>
<p>Le refreshToken permet de renforcer la sécurité de l&#x27;ensemble du processus d&#x27;authentification et d&#x27;autorisation. Par exemple, si le client souhaite se déconnecter d&#x27;une session, il lui suffit de révoquer le refreshToken associé au JWT, ce qui forcera le client à demander à l&#x27;utilisateur de s&#x27;authentifier lorsque le JWT expire.</p>
<p>Un autre cas très pratique est lorsqu&#x27;il y a un changement dans les autorisations d&#x27;un utilisateur. Dans ce cas, nous pouvons révoquer tous les refresh tokens associés aux sessions ouvertes de l&#x27;utilisateur, ce qui forcera aussi le client à demander à l&#x27;utilisateur de s&#x27;authentifier à nouveau lorsque le JWT expire. Ainsi, le client pourra obtenir les nouvelles autorisations.</p>
<h1>Comprendre l&#x27;architecture de Spring Security</h1>
<p><img decoding="async" loading="lazy" src="/assets/images/springSecuirtyArch.drawio-b74e1f8a2cb220b91bef787bf7b05641.png" width="1325" height="799" class="img_ev3q"></p>
<p>En me basant sur le diagramme ci-dessus, je vais vous expliquer l&#x27;architecture de Spring Security et son mode de fonctionnement.</p>
<p>Spring Security repose sur un concept central pour le traitement des requêtes HTTP : les filtres. Il utilise une chaîne de filtres pour intercepter les requêtes entrantes, ce qui permet de mettre en œuvre la gestion de l&#x27;authentification, de l&#x27;autorisation et de la protection contre les attaques.</p>
<p><strong>DelegatingFilterProxy</strong> est une implémentation de l&#x27;interface jakarta.servlet.Filter fournie par le framework Spring pour intégrer les filtres de servlet dans l&#x27;infrastructure de Spring.</p>
<p>Techniquement, lorsqu&#x27;on utilise des filtres de servlet, on doit évidemment les déclarer en tant que classe de filtre dans notre configuration ou web.xml, sinon le conteneur de servlet les ignorera. Le <strong>DelegatingFilterProxy</strong> de Spring assure le lien entre web.xml et le contexte de l&#x27;application. Il agit comme un point d&#x27;entrée unique pour les filtres de servlet dans une application web basée sur Spring</p>
<p>Lorsque <strong>DelegatingFilterProxy</strong> reçoit une requête, il délègue la responsabilité du traitement à un filtre spécifique configuré dans la configuration de l&#x27;application.</p>
<p><strong>FilterChainProxy</strong> est une classe spécifique à Spring Security qui gère la chaîne de filtres de sécurité dans une application Spring Security. Elle agit comme un filtre principal qui intercepte toutes les requêtes entrantes et les achemine à travers une chaîne de filtres de sécurité configurés.</p>
<p>La configuration des filtres de sécurité dans <strong>FilterChainProxy</strong> se fait généralement à l&#x27;aide du bean <strong>SecurityFilterChain</strong>.</p>
<p><strong>SecurityFilterChain</strong> permet de configurer précisément les règles de sécurité en spécifiant quels filtres doivent être appliqués dans quel ordre pour chaque chemin d&#x27;accès ou URL spécifique. Cela offre une grande flexibilité pour adapter les règles de sécurité en fonction des besoins spécifiques de l&#x27;application.</p>
<p>Dans notre exemple, nous allons modifier la configuration de Spring en fournissant une instance de <strong>SecurityFilterChain</strong> qui répond aux exigences de sécurité de notre API.</p>
<p>Spring nous fournit une liste de filtres qui sont exécutés dans un certain ordre. Il n&#x27;est pas nécessaire de connaître tous les filtres implémentés par Spring, car ce n&#x27;est pas l&#x27;objectif de cet article. Cependant, vous pouvez consulter la documentation officielle pour obtenir plus de détails à ce sujet. Néanmoins, je vais expliquer quelques filtres que j&#x27;ai inclus dans l&#x27;architecture.</p>
<ul>
<li><strong>UsernamePasswordAuthenticationFilter</strong> : Son rôle est de gérer l&#x27;authentification basée sur un formulaire. Plus précisément, ce filtre est responsable de l&#x27;analyse d&#x27;une soumission de formulaire d&#x27;authentification contenant un couple nom d&#x27;utilisateur/mot de passe. Pour notre système d&#x27;authentification stateless, ce filtre n&#x27;est pas utile et peut être exclu afin de se concentrer sur le filtre <strong>JwtAuthenticationFilter</strong>.</li>
<li><strong>JwtAuthenticationFilter</strong> : C&#x27;est un filtre personnalisé qui est responsable de la validation des JWT. Il permet d&#x27;intercepter chaque requête HTTP, vérifier la présence d&#x27;un JWT, extraire puis le valider avant de passer la main aux autres filtres de la chaîne.</li>
<li><strong>ExceptionTranslationFilter</strong> : C&#x27;est un filtre important dans Spring Security. Son rôle principal est de gérer les exceptions liées à la sécurité qui se produisent lors du traitement des requêtes et de les traduire en réponses HTTP appropriées. Par exemple, il peut renvoyer une réponse 403 (interdit) si une exception de type <strong>AccessDeniedException</strong> se produit.</li>
<li><strong>AuthorizationFilter</strong> (FilterSecurityInterceptor - déprécié depuis la version 5.5) : Il effectue les vérifications d&#x27;autorisation basées sur les rôles de l&#x27;utilisateur connecté (nous en verrons plus dans la pratique). À noter que ce filtre est configuré avec un <strong>AccessDecisionManager</strong> qui prend la décision finale concernant l&#x27;autorisation d&#x27;une requête en se basant sur les attributs de sécurité et les décisions prises par les <strong>AccessDecisionVoters</strong>.</li>
</ul>
<p><strong>UsernamePasswordAuthenticationToken</strong> est une implémentation de l&#x27;interface <strong>Authentication</strong> spécifique à l&#x27;authentification basée sur le nom d&#x27;utilisateur et le mot de passe. Il hérite de la classe abstraite <strong>AbstractAuthenticationToken</strong> et représente l&#x27;identité de l&#x27;utilisateur à authentifier.</p>
<p><strong>Authentication</strong> encapsule les détails de l&#x27;authentification tels que le nom d&#x27;utilisateur, les rôles, les autorisations, etc.</p>
<p>Voici à quoi ressemble l&#x27;objet <strong>Authentication</strong> :</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;authorities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;authority&quot;: &quot;UPDATE_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;authority&quot;: &quot;DELETE_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;authority&quot;: &quot;READ_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;authority&quot;: &quot;WRITE_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;authority&quot;: &quot;ROLE_ADMIN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;details&quot;: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;authenticated&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;principal&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;id&quot;: 1,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;firstname&quot;: &quot;mossaab&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;lastname&quot;: &quot;frifita&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;email&quot;: &quot;frifita1@gmail.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;password&quot;: &quot;$2a$10$laYzRwXuWpueMZyJfxmOu.MsG9wAaoKjnbuoPW3xvZ9za2G.IwCfm&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;role&quot;: &quot;ADMIN&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;enabled&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;accountNonLocked&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;accountNonExpired&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;credentialsNonExpired&quot;: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;authorities&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;authority&quot;: &quot;UPDATE_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;authority&quot;: &quot;DELETE_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;authority&quot;: &quot;READ_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;authority&quot;: &quot;WRITE_PRIVILEGE&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;authority&quot;: &quot;ROLE_ADMIN&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;username&quot;: &quot;frifita1@gmail.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;credentials&quot;: null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;name&quot;: &quot;frifita1@gmail.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>SecurityContextHolder</strong> est utilisé pour accéder au <strong>SecurityContext</strong> et effectuer des opérations sur celui-ci, telles que la récupération de l&#x27;objet <strong>Authentication</strong>, la définition d&#x27;un nouvel objet <strong>Authentication</strong> ou la suppression du contexte de sécurité. Son objectif est de représenter l&#x27;état d&#x27;authentification de l&#x27;utilisateur.</p>
<p><strong>AuthenticationManger</strong> est le point d&#x27;entrée du processus d&#x27;authentification. son rôle est d&#x27;authentifier l&#x27;utilisateur émetteur de la requête. C&#x27;est une interface qui possède une seule méthode <strong>authenticate</strong> qui renvoie un objet <strong>Authentication</strong></p>
<p>L&#x27;implémentation par défaut fournie par Spring est la classe <strong>ProviderManager</strong>. Elle est responsable de l&#x27;orchestration des différents <strong>AuthenticationProviders</strong> utilisés pour valider une demande d&#x27;authentification. Lorsqu&#x27;une demande d&#x27;authentification est reçue, le ProviderManager itère sur la liste des AuthenticationProviders configurés et délègue la responsabilité de l&#x27;authentification à l&#x27;un d&#x27;entre eux. Le ProviderManager tente les différents providers (par exemple LDAP, base de données) jusqu&#x27;à ce qu&#x27;une authentification réussie soit obtenue ou jusqu&#x27;à ce qu&#x27;il n&#x27;y ait plus de providers à essayer.</p>
<p>Un <strong>Provider</strong> est une implémentation de <strong>AuthenticationProvider</strong> qui définit comment l&#x27;utilisateur doit être authentifié. Dans notre exemple, nous allons utiliser le <strong>DAOAuthenticationProvider</strong> fourni par Spring.</p>
<p>Sachez que vous pouvez créer votre propre fournisseur en fournissant simplement une implémentation de l&#x27;interface <strong>AuthenticationProvider</strong>.</p>
<p><strong>DAOAuthenticationProvider</strong> est utilisé pour l&#x27;authentification basée sur le couple nom d&#x27;utilisateur/mot de passe stocké dans une base de données. Il utilise <strong>UserDetailsService</strong> pour récupérer les informations de l&#x27;utilisateur et <strong>PasswordEncoder</strong> pour comparer le mot de passe fourni avec celui stocké.</p>
<p>Si le provider  a réussi à authentifier l&#x27;utilisateur, il retourne un objet <strong>Authentication</strong>. En cas d&#x27;échec (nom d&#x27;utilisateur ou mot de passe invalide), une <strong>AuthenticationException</strong> est levée.</p>
<p><strong>AuthenticationEntryPoint</strong> c&#x27;est un gestionnaire des erreurs d&#x27;authentification, on peut dire que c&#x27;est un handler en quelque sorte. Il est responsable de la gestion des exceptions liées à l&#x27;authentification et de la création des réponses appropriées à renvoyer au client lorsque ces exceptions se produisent. Il peut être configuré pour renvoyer différentes réponses d&#x27;erreur personnalisées en fonction du type et du code d&#x27;erreur. Par exemple le code HTTP 401 (unauthorized) ou 403 (Forbidden)</p>
<p>Faisons un petit récapitulatif pour vous aider à mémoriser ce qu&#x27;on vient d&#x27;expliquer :</p>
<p><img decoding="async" loading="lazy" src="/assets/images/authManager.drawio-cd56a74d3e9c2530c02cc50274c6f810.png" width="201" height="427" class="img_ev3q"></p>
<p><strong>UserDetailsService</strong> est une interface qui propose une méthode <strong>loadByUsername</strong> pour récupérer un utilisateur par son nom d&#x27;utilisateur. Elle retourne un objet implémentant l&#x27;interface <strong>UserDetails</strong>.</p>
<p>Spring Security nous propose la classe <strong>User</strong>, qui est une implémentation par défaut de l&#x27;interface <strong>UserDetails</strong>. Comme vous pouvez le voir sur le diagramme, la classe <strong>User</strong> fournit des propriétés importantes telles que le nom d&#x27;utilisateur, le mot de passe et les autorités nécessaires pour la vérification des autorisations lors du processus d&#x27;authentification.</p>
<p>Il est possible de surcharger la classe <strong>User</strong> ou d&#x27;implémenter directement l&#x27;interface <strong>UserDetails</strong> si l&#x27;on souhaite ajouter des informations supplémentaires spécifiques à notre application. Ainsi, pour que notre classe utilisateur soit un utilisateur de Spring Security, elle doit soit étendre la classe <strong>User</strong>, ou bien implémenter l&#x27;interface <strong>UserDetails</strong> (qui étend également la classe <strong>User</strong>).</p>
<p>Enfin, l&#x27;interface <strong>PasswordEncoder</strong> est proposée par Spring Security pour encoder et comparer les mots de passe. Elle offre également deux implémentations, <strong>StandardPasswordEncoder</strong> et <strong>BCryptPasswordEncoder</strong>.</p>
<p>Spring Security recommande l&#x27;utilisation de <strong>BCryptPasswordEncoder</strong>, comme indiqué dans la documentation officielle.</p>
<p><img decoding="async" loading="lazy" src="/assets/images/bCrypt-eb033901ba6502c8bef94b09fef06530.PNG" width="683" height="132" class="img_ev3q"></p>
<p>Avant de passer à l&#x27;implémentation, je préfère que nous jetions un coup d&#x27;œil sur le mécanisme d&#x27;authentification et d&#x27;autorisation dans Spring Security.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="comprendre-le-mécanisme-de-lauthentification-et-lautorisation">Comprendre le mécanisme de l&#x27;authentification et l&#x27;autorisation<a href="#comprendre-le-mécanisme-de-lauthentification-et-lautorisation" class="hash-link" aria-label="Lien direct vers Comprendre le mécanisme de l&#x27;authentification et l&#x27;autorisation" title="Lien direct vers Comprendre le mécanisme de l&#x27;authentification et l&#x27;autorisation">​</a></h2>
<p><img decoding="async" loading="lazy" src="/assets/images/springAuthAut.drawio-4a7453b06274a82066c0d2bc75154bdf.png" width="1151" height="749" class="img_ev3q"></p>
<p>En se basant sur le digramme ci-dessus on peut en conclure deux scénarios :</p>
<ol>
<li>Lorsque l&#x27;on souhaite authentifier un utilisateur par le couple/usrename et lui envoyer les données de sa session sous forme d&#x27;un JWT</li>
<li>Lorsqu&#x27;un utilisateur tente d&#x27;accéder à une ressource protégée qui peut nécessite ou non des autorisations spécifiques</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authentification-dun-utilisateur">Authentification d&#x27;un utilisateur<a href="#authentification-dun-utilisateur" class="hash-link" aria-label="Lien direct vers Authentification d&#x27;un utilisateur" title="Lien direct vers Authentification d&#x27;un utilisateur">​</a></h3>
<p>Lorsqu&#x27;un utilisateur soumet une requête HTTP d&#x27;authentification, elle traverse la chaîne de filtres jusqu&#x27;à atteindre le contrôleur chargé de l&#x27;authentification. Ensuite, le contrôleur demande au service d&#x27;authentification de vérifier les informations fournies par l&#x27;utilisateur.</p>
<p>Voici les étapes simplifiées d&#x27;authentification d&#x27;un utilisateur dans Spring Security avec JWT :</p>
<ol>
<li>L&#x27;utilisateur soumet ses informations d&#x27;identification (nom d&#x27;utilisateur et mot de passe) via un formulaire de connexion ou une requête API.</li>
<li>Le filtre <strong>JwtAuthenticationFilter</strong> intercepte la demande d&#x27;authentification.</li>
<li>Dans <strong>JwtAuthenticationFilter</strong>, l&#x27;authentification de l&#x27;utilisateur est effectuée en vérifiant les informations d&#x27;identification fournies.</li>
<li>Si l&#x27;authentification réussit, un objet <strong>UsernamePasswordAuthenticationToken</strong> est créé pour représenter l&#x27;identité de l&#x27;utilisateur authentifié.</li>
<li>Le contrôleur reçoit la demande d&#x27;authentification réussie et utilise un service approprié pour générer une réponse à l&#x27;utilisateur</li>
<li>Le service crée un jeton d&#x27;accès JWT en incluant les informations nécessaires (par exemple, le nom d&#x27;utilisateur, les autorisations, la durée de validité) et en le signant avec une clé secrète.</li>
<li>La réponse contenant le jeton d&#x27;accès JWT est renvoyée à l&#x27;utilisateur.</li>
</ol>
<p>Dans ce scénario, on pourrait dire que l&#x27;authentification se fait entièrement dans le service d&#x27;authentification, car les filtres ne sont pas directement impliqués dans le processus.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="demander-une-ressource-nécessitant-lauthentification">Demander une ressource nécessitant l&#x27;authentification<a href="#demander-une-ressource-nécessitant-lauthentification" class="hash-link" aria-label="Lien direct vers Demander une ressource nécessitant l&#x27;authentification" title="Lien direct vers Demander une ressource nécessitant l&#x27;authentification">​</a></h3>
<p>Pour accéder à une ressource protégée dans notre système d&#x27;authentification Stateless, il est nécessaire de fournir un JWT valide qui atteste les autorisations requises.</p>
<p>La requête va être intercepté par le filtre <code>JwtAuthenticationFilter</code> qui va exporter le JWT</p>
<ol>
<li>Un utilisateur envoie une requête HTTP pour accéder à une ressource protégée dans notre application.</li>
<li>La requête est interceptée par le <code>JwtAuthenticationFilter</code>, qui vérifie la présence d&#x27;un JWT dans l&#x27;en-tête <code>Authorization</code>.</li>
<li>Si le JWT est présent, le <code>JwtAuthenticationFilter</code> extrait et valide le JWT en utilisant une clé secrète ou publique.</li>
<li>Si le JWT est valide, le <code>JwtAuthenticationFilter</code> extrait les informations d&#x27;identification (comme le username) du JWT.</li>
<li>On récupère ensuite les détails de l&#x27;utilisateur en utilisant son username depuis la BDD.</li>
<li>Si l&#x27;utilisateur n&#x27;existe pas ou si d&#x27;autres critères de validation supplémentaires liés aux besoins spécifiques de l&#x27;application ne sont pas satisfaits, une exception peut être levée.</li>
<li>Si l&#x27;authentification est réussie, Le <code>JwtAuthenticationFilter</code> crée ensuite un objet <code>UsernamePasswordAuthenticationToken</code> contenant les informations d&#x27;identification de l&#x27;utilisateur.</li>
<li>L&#x27;objet <code>UsernamePasswordAuthenticationToken</code> est stocké dans le SecurityContext, géré par le <code>SecurityContextHolder</code>.</li>
<li>La requête continue son chemin et traverse la chaîne de filtres jusqu&#x27;à ce qu&#x27;elle atteigne le contrôleur</li>
<li>Si l&#x27;authentification échoue à l&#x27;une des étapes, une exception est levée.</li>
</ol>
<h1>Implémentation</h1>
<p>Tout cela est très bien en théorie, mais rien de mieux que la pratique pour mettre en œuvre tout ce que nous avons vu.</p>
<p>L&#x27;objectif est de créer une API REST Spring boot sécurisée par Spring security avec JWT (Json Web Token).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="les-endpoints">Les endpoints<a href="#les-endpoints" class="hash-link" aria-label="Lien direct vers Les endpoints" title="Lien direct vers Les endpoints">​</a></h3>
<p>Voici les endpoints que notre API doit exposés :</p>
<ul>
<li>POST /api/v1/auth/register =&gt; permet de créer un nouveau compte utilisateur</li>
<li>POST /api/v1/auth/authenticate =&gt; authentification</li>
<li>POST /api/v1/auth/refresh-token =&gt; permet d&#x27;actualiser le token</li>
<li>GET /api/v1/admin/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle admin et le droit de lecture</li>
<li>DELETE /api/v1/admin/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle admin et le droit de suppression</li>
<li>POST /api/v1/user/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle user et le droit de création</li>
<li>PUT /api/v1/user/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle user et le droit de modification</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="initialisation-du-projet">Initialisation du projet<a href="#initialisation-du-projet" class="hash-link" aria-label="Lien direct vers Initialisation du projet" title="Lien direct vers Initialisation du projet">​</a></h3>
<p>Afin de ne pas alourdir l&#x27;article, l&#x27;objectif est de se concentrer sur Spring Security. Je vais passer certaines étapes classiques que chaque développeur Java devrait savoir faire, comme la création d&#x27;un projet Spring Boot, et je vais sauter également les lignes de code qui ne sont pas particulièrement importantes. Vous pouvez trouver le projet complet sur <a href="https://github.com/MossaabFrifita/spring-boot-3-security-6-jwt" target="_blank" rel="noopener noreferrer">GitHub</a>, mais je vous recommande vivement de ne pas simplement copier-coller le code. Essayez plutôt de manipuler les choses par vous-même et n&#x27;hésitez pas à apporter vos propres modifications pour améliorer certaines parties ou ajouter de nouvelles fonctionnalités.</p>
<p>La première étape est de créer un projet spring boot et ajouter la dépendance de spring Security, lombok et postgresql ou bien tout autre SGBD de votre choix. Au moment où j&#x27;écris cet article on est à la version 3.1 de Spring boot qui nécessite au minimum Java 17.</p>
<p>Une fois le projet créé, importez-le dans votre IDE préféré et essayez de le démarrer. Normalement, vous devriez voir s&#x27;afficher par défaut une page de connexion générée automatiquement par Spring Security. Si vous consultez la console, vous verrez que Spring a généré un mot de passe par défaut pour l&#x27;utilisateur &quot;user&quot; lors du démarrage de l&#x27;application. Notez que vous pouvez personnaliser cette page, mais dans le cas de notre API, nous n&#x27;en aurons pas besoin.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="création-des-énumérations">Création des énumérations<a href="#création-des-énumérations" class="hash-link" aria-label="Lien direct vers Création des énumérations" title="Lien direct vers Création des énumérations">​</a></h3>
<p>Sous le package &quot;enums&quot;, créez l&#x27;énumération <strong>Privilege</strong> qui définit explicitement les autorisations qui seront attribuées à chaque rôle :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.enums;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum Privilege {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    READ_PRIVILEGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    WRITE_PRIVILEGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DELETE_PRIVILEGE,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UPDATE_PRIVILEGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Créez également l&#x27;énumération <strong>Role</strong> :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.enums;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Getter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Set;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.stream.Collectors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import static fr.mossaab.security.enums.Privilege.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum Role {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ADMIN(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Set.of(READ_PRIVILEGE,WRITE_PRIVILEGE,UPDATE_PRIVILEGE,DELETE_PRIVILEGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    USER(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Set.of(READ_PRIVILEGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Getter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Set&lt;Privilege&gt; privileges;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;SimpleGrantedAuthority&gt; getAuthorities(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        List&lt;SimpleGrantedAuthority&gt; authorities = getPrivileges()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(privilege -&gt; new SimpleGrantedAuthority(privilege.name()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .collect(Collectors.toList());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authorities.add(new SimpleGrantedAuthority(&quot;ROLE_&quot;+this.name()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return authorities;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Pour chaque rôle, on définit un ensemble de privilèges dans le constructeur, ce qui permet d&#x27;initialiser le rôle avec ses autorisations.</p>
<p>La méthode <code>getAuthorities()</code> retourne une liste d&#x27;objets <code>SimpleGrantedAuthority</code> obtenue en transformant la (Set) de privilèges.</p>
<p>Pour que Spring Security puisse effectuer des vérifications de rôles et d&#x27;autorisations, il faut lui fournir une liste de <code>SimpleGrantedAuthority</code></p>
<p><strong>SimpleGrantedAuthority</strong> est une implémentation couramment utilisée de l&#x27;interface <code>GrantedAuthority</code>. Les objets <code>SimpleGrantedAuthority</code> sont utilisés pour encapsuler le nom d&#x27;une autorité ou d&#x27;un rôle dans le système.</p>
<p>Le préfixe &quot;ROLE&quot; est une convention utilisée par Spring Security pour différencier les rôles des autres types d&#x27;autorités.</p>
<p>En résumé, une <strong>Authority</strong>  n&#x27;est qu&#x27;une simple chaine de caractères encapsulée dans  <strong>SimpleGrantedAuthority</strong>. un Rôle n’est ni plus ni moins qu’une <strong>Authority</strong> précédée du préfixe “ROLE_”</p>
<p>Créez aussi l&#x27;énumération <strong>TokenType</strong></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.enums;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum TokenType {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BEARER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Le type d&#x27;authentification Bearer est utilisé dans les protocoles basés sur les tokens tels que JWT et OAuth 2.0. Lorsque on utilise l&#x27;authentification Bearer, le client inclut le token d&#x27;accès dans l&#x27;en-tête de la requête HTTP(Headers) , généralement dans l&#x27;en-tête d&#x27;autorisation, avec le préfixe &quot;Bearer &quot;. Par exemple : &quot;Authorization: Bearer token&quot;.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="création-de-lentité-user">Création de l&#x27;entité User<a href="#création-de-lentité-user" class="hash-link" aria-label="Lien direct vers Création de l&#x27;entité User" title="Lien direct vers Création de l&#x27;entité User">​</a></h3>
<p>Créez la classe User qui implémente <code>UserDetails</code> sous le package entities</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.entities;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.enums.Role;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.persistence.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Collection;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Table(name = &quot;_user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class User implements UserDetails {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GeneratedValue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Long id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String firstname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String lastname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Enumerated(EnumType.STRING)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Role role;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return role.getAuthorities();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getPassword() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String getUsername() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isAccountNonExpired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isAccountNonLocked() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isCredentialsNonExpired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isEnabled() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>La classe User est utilisée pour représenter un utilisateur dans Spring Security. Elle fournit les informations nécessaires pour l&#x27;authentification et l&#x27;autorisation, ainsi que les autorités associées à l&#x27;utilisateur.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="création-de-lentité-refreshtoken">Création de l&#x27;entité RefreshToken<a href="#création-de-lentité-refreshtoken" class="hash-link" aria-label="Lien direct vers Création de l&#x27;entité RefreshToken" title="Lien direct vers Création de l&#x27;entité RefreshToken">​</a></h3>
<p>Comme mentionné précédemment dans cet article, en enregistrant les Refresh Tokens dans la base de données, il devient plus facile de gérer leur état, notamment pour les révoquer si nécessaire. Par exemple, si un utilisateur perd son appareil ou souhaite se déconnecter de manière proactive, le Refresh Token peut être marqué comme révoqué dans la base de données, empêchant ainsi son utilisation future. On peut aussi contrôler le nombre de sessions ouvertes par l&#x27;utilisateur.</p>
<p>Voici la classe RefreshToken</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.entities;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.enums.TokenType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.persistence.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.Instant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Entity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RefreshToken {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GeneratedValue(strategy = GenerationType.AUTO)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ManyToOne</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JoinColumn(name = &quot;user_id&quot;, referencedColumnName = &quot;id&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private User user;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(nullable = false, unique = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String token;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Column(nullable = false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Instant expiryDate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean revoked;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="création-des-repositories-user-et-refreshtoken">Création des Repositories User et RefreshToken<a href="#création-des-repositories-user-et-refreshtoken" class="hash-link" aria-label="Lien direct vers Création des Repositories User et RefreshToken" title="Lien direct vers Création des Repositories User et RefreshToken">​</a></h3>
<p>Maintenant, nos entités nécessitent un Repository pour la persistance et l&#x27;accès aux données en base de données. Créez-les dans le package repository.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.repository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.entities.User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.jpa.repository.JpaRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Optional;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface UserRepository extends JpaRepository&lt;User, Long&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional&lt;User&gt; findByEmail(String email);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-Java language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.repository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.entities.RefreshToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.data.jpa.repository.JpaRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Optional;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface RefreshTokenRepository extends JpaRepository&lt;RefreshToken, Long&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Optional&lt;RefreshToken&gt; findByToken(String token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="définition-des-payloads">Définition des payloads<a href="#définition-des-payloads" class="hash-link" aria-label="Lien direct vers Définition des payloads" title="Lien direct vers Définition des payloads">​</a></h3>
<p>Notre API a besoin de définir les payloads pour les requêtes et les réponses.</p>
<ul>
<li>
<p>Les requêtes :</p>
<ul>
<li>
<p><code>AuthenticationRequest</code> : permet d&#x27;encapsuler les données de la requête d&#x27;authentification</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.payload.request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthenticationRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><code>RefreshTokenRequest</code> : permet d&#x27;encapsuler les données de la requête de rafraîchissement du token.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.payload.request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RefreshTokenRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String refreshToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><code>RegisterRequest</code>: permet d&#x27;encapsuler les données de la requête d&#x27;inscription</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.payload.request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.enums.Role;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.validation.StrongPassword;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.validation.constraints.Email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.validation.constraints.NotBlank;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.validation.constraints.NotNull;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RegisterRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NotBlank(message = &quot;firstname is required&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String firstname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NotBlank(message = &quot;lastname is required&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String lastname;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NotBlank(message = &quot;email is required&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Email(message = &quot;email format is not valid&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NotBlank(message = &quot;password is required&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @StrongPassword</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String password;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @NotNull</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Role role;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
<li>
<p>Les réponses :</p>
<ul>
<li>
<p><code>AuthenticationResponse</code> : permet d&#x27;encapsuler les données de la réponse d&#x27;authentification</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.payload.response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.annotation.JsonProperty;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthenticationResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private  Long id;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String email;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;String&gt; roles;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JsonProperty(&quot;access_token&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JsonProperty(&quot;refresh_token&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String refreshToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JsonProperty(&quot;token_type&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String tokenType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><code>RefreshTokenResponse</code>:  permet d&#x27;encapsuler les données de la réponse de rafraîchissement du token.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.payload.response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.annotation.JsonProperty;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.enums.TokenType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RefreshTokenResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JsonProperty(&quot;access_token&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String accessToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JsonProperty(&quot;refresh_token&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String refreshToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @JsonProperty(&quot;token_type&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String tokenType = TokenType.BEARER.name();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implémentation-du-service-jwtservice">Implémentation du Service JwtService<a href="#implémentation-du-service-jwtservice" class="hash-link" aria-label="Lien direct vers Implémentation du Service JwtService" title="Lien direct vers Implémentation du Service JwtService">​</a></h3>
<p>Le <code>JwtService</code> est une interface qui définit des méthodes permettant de générer, extraire et valider les JWT. Cette interface joue un rôle essentiel dans la gestion des JWT et fournit des fonctionnalités importantes pour les manipuler.</p>
<p>Les méthodes principales de cette classe sont :</p>
<ul>
<li><code>extractUserName(String token)</code> : Cette méthode extrait le nom d&#x27;utilisateur à partir du JWT.</li>
<li><code>generateToken(UserDetails userDetails)</code> : Cette méthode génère un nouveau JWT à partir des informations de l&#x27;utilisateur fourni.</li>
<li><code>isTokenValid(String token, UserDetails userDetails)</code> : Cette méthode vérifie si un JWT est valide en comparant le nom d&#x27;utilisateur extrait du JWT avec le nom d&#x27;utilisateur fourni par <code>UserDetails</code>. Elle vérifie également si le JWT a expiré.</li>
</ul>
<p>On a besoin de la bibliothèque <code>io.jsonwebtoken</code> pour générer et valider les JWT. Ajoutez les dépendances suivantes dans vote pom.xml :</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">&lt;!-- ===== jjwt ===== --&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.jsonwebtoken</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jjwt-api</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.11.5</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.jsonwebtoken</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jjwt-impl</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.11.5</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">io.jsonwebtoken</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">jjwt-jackson</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">0.11.5</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Elle utilise également des propriétés configurées dans le fichier de configuration (application.yml), telles que la clé secrète et les durées d&#x27;expiration des JWT.</p>
<p>Créez l&#x27;implémentation <code>JwtServiceImpl</code> du service <code>JwtService</code> :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.service.impl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.JwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.Claims;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.Jwts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.SignatureAlgorithm;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.io.Decoders;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.security.Keys;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.security.Key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Date;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.function.Function;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JwtServiceImpl implements JwtService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${application.security.jwt.secret-key}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String secretKey;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${application.security.jwt.expiration}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long jwtExpiration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${application.security.jwt.refresh-token.expiration}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long refreshExpiration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String extractUserName(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extractClaim(token, Claims::getSubject);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String generateToken(UserDetails userDetails) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return generateToken(new HashMap&lt;&gt;(), userDetails);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public boolean isTokenValid(String token, UserDetails userDetails) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String userName = extractUserName(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return (userName.equals(userDetails.getUsername())) &amp;&amp; !isTokenExpired(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private boolean isTokenExpired(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extractExpiration(token).before(new Date());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Date extractExpiration(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return extractClaim(token, Claims::getExpiration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String generateToken(Map&lt;String, Object&gt; extraClaims, UserDetails userDetails) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return buildToken(extraClaims, userDetails,jwtExpiration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String buildToken(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; extraClaims,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UserDetails userDetails,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long expiration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Jwts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .setClaims(extraClaims)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .setSubject(userDetails.getUsername())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .setIssuedAt(new Date(System.currentTimeMillis()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .setExpiration(new Date(System.currentTimeMillis() + expiration))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .signWith(getSigningKey(), SignatureAlgorithm.HS256)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .compact();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private &lt;T&gt; T extractClaim(String token, Function&lt;Claims, T&gt; claimsResolvers) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final Claims claims = extractAllClaims(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return claimsResolvers.apply(claims);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Claims extractAllClaims(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Jwts.parserBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .setSigningKey(getSigningKey())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .parseClaimsJws(token)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .getBody();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Key getSigningKey() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        byte[] keyBytes = Decoders.BASE64.decode(secretKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Keys.hmacShaKeyFor(keyBytes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>La méthode <code>extractAllClaims</code> est responsable de l&#x27;extraction de toutes les claims d&#x27;un token. elle permet de valider la signature à l&#x27;aide de la clé secrète, puis renvoyer tous Claims ou lever une exception si le token n&#x27;est pas valide. Voici les exceptions qui peuvent être levées :</p>
<ul>
<li><code>ExpiredJwtException</code> : Cette exception est levée lorsque le token JWT est expiré et n&#x27;est plus valide.</li>
<li><code>UnsupportedJwtException</code> : Cette exception est levée lorsque le token JWT est malformé ou utilise un algorithme de signature non pris en charge.</li>
<li><code>MalformedJwtException</code> : Cette exception est levée lorsque le token JWT est mal formé ou invalide.</li>
<li><code>SignatureException</code> : Cette exception est levée lorsque la signature du token JWT ne peut pas être vérifiée.</li>
<li><code>IllegalArgumentException</code> : Cette exception est levée lorsqu&#x27;un argument invalide est passé à une méthode.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implémentation-du-service-authenticationservice">Implémentation du Service AuthenticationService<a href="#implémentation-du-service-authenticationservice" class="hash-link" aria-label="Lien direct vers Implémentation du Service AuthenticationService" title="Lien direct vers Implémentation du Service AuthenticationService">​</a></h3>
<p>L&#x27;interface <code>AuthenticationService</code> fournit des méthodes pour l&#x27;enregistrement d&#x27;un nouveau utilisateur (<code>register</code>) et l&#x27;authentification d&#x27;un utilisateur (<code>authenticate</code>).</p>
<p>Créez <code>AuthenticationServiceImpl</code> qui est une classe qui implémente l&#x27;interface <code>AuthenticationService</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.service.impl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.enums.TokenType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.request.AuthenticationRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.request.RegisterRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.response.AuthenticationResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.AuthenticationService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.JwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.entities.User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.repository.UserRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.RefreshTokenService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.AuthenticationManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.authority.SimpleGrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.crypto.password.PasswordEncoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.transaction.annotation.Transactional;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service @Transactional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthenticationServiceImpl implements AuthenticationService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final PasswordEncoder passwordEncoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final JwtService jwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final UserRepository userRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AuthenticationManager authenticationManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final RefreshTokenService refreshTokenService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AuthenticationResponse register(RegisterRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var user = User.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .firstname(request.getFirstname())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .lastname(request.getLastname())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .email(request.getEmail())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .password(passwordEncoder.encode(request.getPassword()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .role(request.getRole())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        user = userRepository.save(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var jwt = jwtService.generateToken(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var refreshToken = refreshTokenService.createRefreshToken(user.getId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var roles = user.getRole().getAuthorities()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(SimpleGrantedAuthority::getAuthority)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .toList();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return AuthenticationResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .accessToken(jwt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .email(user.getEmail())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .id(user.getId())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .refreshToken(refreshToken.getToken())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .roles(roles)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .tokenType( TokenType.BEARER.name())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AuthenticationResponse authenticate(AuthenticationRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authenticationManager.authenticate(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new UsernamePasswordAuthenticationToken(request.getEmail(),request.getPassword()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var user = userRepository.findByEmail(request.getEmail()).orElseThrow(() -&gt; new IllegalArgumentException(&quot;Invalid email 		or password.&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var jwt = jwtService.generateToken(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        var refreshToken = refreshTokenService.createRefreshToken(user.getId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return AuthenticationResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .accessToken(jwt)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .email(user.getEmail())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .id(user.getId())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .refreshToken(refreshToken.getToken())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .tokenType( TokenType.BEARER.name())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>AuthenticationServiceImpl</code> a besoin d&#x27;un :</p>
<ul>
<li><code>PasswordEncoder</code> pour encoder le mot de passe de l&#x27;utilisateur lors de l&#x27;enregistrement.</li>
<li><code>JwtService</code> qu&#x27;on a déjà fourni une implémentation pour générer le JWT lors de l&#x27;enregistrement et le valider lors de l&#x27;authentification.</li>
<li><code>UserRepository</code> pour accéder aux données des utilisateurs en base de données.</li>
<li><code>l&#x27;AuthenticationManager</code> pour effectuer l&#x27;authentification de l&#x27;utilisateur lors de l&#x27;appel à la méthode <code>authenticate</code> qui reçoit un <code>UsernamePasswordAuthenticationToken</code> comme on l&#x27;a vu dans la partie théorique.</li>
<li><code>RefreshTokenService</code> pour créer un token de rafraîchissement lors de l&#x27;enregistrement et de l&#x27;authentification.</li>
</ul>
<p>Dans la méthode <code>register</code>, on crée un nouvel utilisateur en utilisant les informations fournies dans la demande (<code>RegisterRequest</code>), puis on le sauvegarde en base de données. Ensuite, on génère un token JWT pour l&#x27;utilisateur, on crée un token de rafraîchissement et on renvoie une réponse d&#x27;authentification contenant les informations nécessaires.</p>
<p>Dans la méthode <code>authenticate</code>, on utilise l&#x27;<code>AuthenticationManager</code> pour valider les informations d&#x27;authentification de l&#x27;utilisateur (on verra par la suite comment configurer <code>l&#x27;AuthenticationManager</code>). Si l&#x27;authentification est réussie, on récupère l&#x27;utilisateur correspondant à l&#x27;adresse e-mail fournie, on génère un token JWT et un token de rafraîchissement, puis on renvoie une réponse d&#x27;authentification avec les informations appropriées.</p>
<p>Maintenant l&#x27;étape suivante est de fournir une implémentation du service <code>RefreshTokenService</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implémentation-du-service-refreshtokenservice">Implémentation du Service RefreshTokenService<a href="#implémentation-du-service-refreshtokenservice" class="hash-link" aria-label="Lien direct vers Implémentation du Service RefreshTokenService" title="Lien direct vers Implémentation du Service RefreshTokenService">​</a></h3>
<p>RefreshTokenService est responsable de la création, la vérification et la régénération des tokens de rafraîchissement</p>
<p>Il a besoin d&#x27;un :</p>
<ul>
<li><code>UserRepository</code> pour récupérer l&#x27;utilisateur par son ID et vérifier qu&#x27;il fait partie de notre système.</li>
<li><code>RefreshTokenRepository</code> pour gérer le RefreshToken en base de données.</li>
<li><code>JwtService</code> pour générer de nouveaux tokens JWT lors de la régénération.</li>
<li>Attribut qui récupère la durée d&#x27;expiration des RefreshTokens  à partir de la configuration.</li>
</ul>
<p>Créez l&#x27;implémentation  RefreshTokenServiceImpl :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.service.impl;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.entities.RefreshToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.entities.User;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.enums.TokenType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.exception.TokenException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.request.RefreshTokenRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.response.RefreshTokenResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.repository.RefreshTokenRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.repository.UserRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.JwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.RefreshTokenService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Service;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.Instant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Base64;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Optional;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.UUID;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RefreshTokenServiceImpl implements RefreshTokenService {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final UserRepository userRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final RefreshTokenRepository refreshTokenRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final JwtService jwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${application.security.jwt.refresh-token.expiration}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private long refreshExpiration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RefreshToken createRefreshToken(Long userId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        User user = userRepository.findById(userId).orElseThrow(() -&gt; new RuntimeException(&quot;User not found&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RefreshToken refreshToken = RefreshToken.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .revoked(false)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .user(user)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .token(Base64.getEncoder().encodeToString(UUID.randomUUID().toString().getBytes()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .expiryDate(Instant.now().plusMillis(refreshExpiration))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return refreshTokenRepository.save(refreshToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RefreshToken verifyExpiration(RefreshToken token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(token == null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.error(&quot;Token is null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TokenException(null, &quot;Token is null&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(token.getExpiryDate().compareTo(Instant.now()) &lt; 0 ){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            refreshTokenRepository.delete(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throw new TokenException(token.getToken(), &quot;Refresh token was expired. Please make a new authentication request&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return token;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RefreshTokenResponse generateNewToken(RefreshTokenRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        User user = refreshTokenRepository.findByToken(request.getRefreshToken())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(this::verifyExpiration)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .map(RefreshToken::getUser)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElseThrow(() -&gt; new TokenException(request.getRefreshToken(),&quot;Refresh token does not exist&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String token = jwtService.generateToken(user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return RefreshTokenResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .accessToken(token)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .refreshToken(request.getRefreshToken())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .tokenType(TokenType.BEARER.name())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>La méthode <code>createRefreshToken</code> est responsable de la création d&#x27;un nouveau RefreshToken pour un utilisateur spécifié (récupéré à par son ID). Elle génère un token unique à l&#x27;aide de <code>UUID.randomUUID()</code>, l&#x27;encode en Base64, définit la date d&#x27;expiration en fonction de la durée configurée, puis enregistre le token en base de données.</p>
<p>La méthode <code>verifyExpiration</code> est utilisée pour vérifier si le RefreshToken est expiré. Si le token est nul ou est expiré, une exception de type <code>TokenException</code> est levée. On verra aussi par la suite comment cette exception et comment la gérer.</p>
<p>La méthode <code>generateNewToken</code> est appelée lorsqu&#x27;un utilisateur souhaite générer un nouveau token en utilisant un RefreshToken existant. Elle récupère le token de la base de données, vérifie s&#x27;il est expiré, récupère l&#x27;utilisateur associé au token, génère un nouveau token JWT à l&#x27;aide du <code>JwtService</code>, puis renvoie la réponse.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gestion-des-exceptions">Gestion des exceptions<a href="#gestion-des-exceptions" class="hash-link" aria-label="Lien direct vers Gestion des exceptions" title="Lien direct vers Gestion des exceptions">​</a></h3>
<p>Dans la couche services nous avons utilisé une exception personnalisée de type<code>TokenException</code></p>
<p>Créez la classe <code>TokenException</code> qui étend <code>RuntimeException</code> sous le package <code>exception</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.HttpStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.ResponseStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@ResponseStatus(HttpStatus.FORBIDDEN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TokenException extends RuntimeException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public TokenException(String token, String message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        super(String.format(&quot;Failed for [%s]: %s&quot;, token, message));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Créez également classe <code>ErrorResponse</code> qui va encapsuler les informations d&#x27;une réponse d&#x27;erreur qui sera envoyé à l&#x27;utilisateur</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.handlers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.AllArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Builder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.Data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.NoArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.Instant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor @AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ErrorResponse {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private int status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String error;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Instant timestamp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String path;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Voici une explication des attributs de la classe :</p>
<ul>
<li><code>status</code> : C&#x27;est le code de statut de l&#x27;erreur HTTP par exemple (401,403).</li>
<li><code>error</code> : Une chaîne de caractères représentant le type d&#x27;erreur.</li>
<li><code>timestamp</code> : Le moment où l&#x27;erreur s&#x27;est produite.</li>
<li><code>message</code> :  Le message détaillé décrivant l&#x27;erreur.</li>
<li><code>path</code> : L&#x27;URI de la requête qui a déclenché l&#x27;erreur.</li>
</ul>
<p>Ensuite, nous avons besoin d&#x27;un Handler qui intercepte les exceptions levées et fournit une réponse personnalisée en utilisant notre classe <code>ErrorResponse</code> que nous venons de créer :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.handlers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.exception.TokenException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.HttpStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.ResponseEntity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.ExceptionHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.ResponseStatus;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.RestControllerAdvice;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.context.request.WebRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.Instant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Arrays;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.HashMap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestControllerAdvice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class TokenControllerHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ExceptionHandler(value = TokenException.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @ResponseStatus(HttpStatus.FORBIDDEN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;ErrorResponse&gt; handleRefreshTokenException(TokenException ex, WebRequest request){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       final ErrorResponse errorResponse = ErrorResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timestamp(Instant.now())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .error(&quot;Invalid Token&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .status(HttpStatus.FORBIDDEN.value())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .message(ex.getMessage())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(request.getDescription(false))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new ResponseEntity&lt;&gt;(errorResponse,HttpStatus.FORBIDDEN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>@RestControllerAdvice</code> est une annotation qui indique à Spring qu&#x27;il s&#x27;agit d&#x27;un composant global qui intercepte les exceptions levées par les contrôleurs et fournit une réponse appropriée.</p>
<p>La méthode <code>handleRefreshTokenException</code> est annotée avec <code>@ExceptionHandler</code> pour spécifier qu&#x27;elle doit être exécutée lorsqu&#x27;une exception de type <code>TokenException</code> est levée.</p>
<p>Lorsqu&#x27;une <code>TokenException</code> est levée, cette méthode est appelée pour la gérer. Elle reçoit l&#x27;exception (<code>ex</code>) et l&#x27;objet <code>WebRequest</code> associé à la requête en cours.</p>
<p>La méthode crée une instance d&#x27;<code>ErrorResponse</code> avec les détails de l&#x27;erreur, ensuite, elle retourne une <code>ResponseEntity</code> contenant l&#x27;objet <code>ErrorResponse</code> et le code de statut HTTP correspondant (ici, <code>HttpStatus.FORBIDDEN</code>).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="création-des-contrôleurs-rest">Création des contrôleurs Rest<a href="#création-des-contrôleurs-rest" class="hash-link" aria-label="Lien direct vers Création des contrôleurs Rest" title="Lien direct vers Création des contrôleurs Rest">​</a></h3>
<p>Maintenant que notre couche service est d éveloppée, il est temps de créer les contrôleurs. Pour notre API, nous avons besoin d&#x27;un contrôleur qui sera responsable de l&#x27;authentification et d&#x27;un autre qui simule l&#x27;accès à des ressources protégées.</p>
<p>Créez alors <code>AuthenticationController</code> qui contient trois méthodes : <code>register</code> qui gère la requête d&#x27;inscription, <code>authenticate</code>  qui gère la requête d&#x27;authentification et <code>refreshToken</code> pour actualiser le JWT</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.request.AuthenticationRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.request.RefreshTokenRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.request.RegisterRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.response.AuthenticationResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.payload.response.RefreshTokenResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.AuthenticationService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.RefreshTokenService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.validation.Valid;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.ResponseEntity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/api/v1/auth&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthenticationController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AuthenticationService authenticationService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final RefreshTokenService refreshTokenService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/register&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;AuthenticationResponse&gt; register(@Valid @RequestBody RegisterRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(authenticationService.register(request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/authenticate&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;AuthenticationResponse&gt; authenticate(@RequestBody AuthenticationRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(authenticationService.authenticate(request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/refresh-token&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;RefreshTokenResponse&gt; refreshToken(@RequestBody RefreshTokenRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(refreshTokenService.generateNewToken(request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>L&#x27;annotation <code>@Valid</code> indique à Spring que <code>RegisterRequest</code> doit être validé. Je ne vais pas entrer dans les détails de la validation des beans, car ce n&#x27;est pas le sujet de cet article.</p>
<p>Ce contrôleur est annoté avec <code>@RestController</code> pour indiquer qu&#x27;il est responsable de la gestion des requêtes REST, et les différentes méthodes sont annotées avec <code>@PostMapping</code> pour spécifier le type de requête HTTP qu&#x27;elles traitent.</p>
<p>Créez <code>AuthorizationController</code> qui va simuler l&#x27;accès aux ressources protégées</p>
<p>Le but est de simuler l&#x27;accès aux endpoints protégés qui nécessitent des autorisations spécifiques. Comme vous vous en souvenez, nous avons défini les endpoints suivants :</p>
<ul>
<li>GET /api/v1/admin/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle admin et le droit de lecture</li>
<li>DELETE /api/v1/admin/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle admin et le droit de suppression</li>
<li>POST /api/v1/user/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle user et le droit de création</li>
<li>PUT /api/v1/user/resource =&gt; permet d&#x27;accèder à une ressource protégée qui nécessite le rôle user et le droit de modification</li>
</ul>
<p>Nous allons créer 4 méthodes dans <code>AuthorizationController</code>  pour les exposer :</p>
<ol>
<li><code>sayHelloWithRoleAdminAndReadAuthority()</code>: Cette méthode <code>GET</code> nécessite le rôle <code>ADMIN</code> et l&#x27;autorité de lecture (<code>READ_PRIVILEGE</code>) pour y accéder.</li>
<li><code>sayHelloWithRoleAdminAndDeleteAuthority()</code>: Cette méthode <code>DELETE</code> nécessite le rôle <code>ADMIN</code> et l&#x27;autorité de suppression (<code>DELETE_PRIVILEGE</code>) pour y accéder.</li>
<li><code>sayHelloWithRoleUserAndCreateAuthority()</code>: Cette méthode <code>POST</code> nécessite le rôle <code>USER</code> et l&#x27;autorité de création (<code>CREATE_PRIVILEGE</code>) pour y accéder. Elle renvoie une réponse indiquant que l&#x27;utilisateur a accès à une ressource protégée nécessitant le rôle utilisateur et l&#x27;autorité de création.</li>
<li><code>sayHelloWithRoleUserAndUpdateAuthority()</code>: Cette méthode <code>PUT</code> nécessite le rôle <code>USER</code> et l&#x27;autorité de mise à jour (<code>UPDATE_PRIVILEGE</code>) pour y accéder.</li>
</ol>
<p>Chaque méthode renvoie simplement un message de succès.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.controller;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.ResponseEntity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.access.prepost.PreAuthorize;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.bind.annotation.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/api/v1&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PreAuthorize(&quot;hasAnyRole(&#x27;ADMIN&#x27;,&#x27;USER&#x27;)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/admin/resource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PreAuthorize(&quot;hasAuthority(&#x27;READ_PRIVILEGE&#x27;) and hasRole(&#x27;ADMIN&#x27;)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;String&gt; sayHelloWithRoleAdminAndReadAuthority() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(&quot;Hello, you have access to a protected resource that requires admin role and read authority.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @DeleteMapping(&quot;/admin/resource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PreAuthorize(&quot;hasAuthority(&#x27;DELETE_PRIVILEGE&#x27;) and hasRole(&#x27;ADMIN&#x27;)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;String&gt; sayHelloWithRoleAdminAndDeleteAuthority() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(&quot;Hello, you have access to a protected resource that requires admin role and delete authority.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/user/resource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PreAuthorize(&quot;hasAuthority(&#x27;CREATE_PRIVILEGE&#x27;) and hasRole(&#x27;USER&#x27;)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;String&gt; sayHelloWithRoleUserAndCreateAuthority() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(&quot;Hello, you have access to a protected resource that requires user role and create authority.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PutMapping(&quot;/user/resource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PreAuthorize(&quot;hasAuthority(&#x27;UPDATE_PRIVILEGE&#x27;) and hasRole(&#x27;USER&#x27;)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public ResponseEntity&lt;String&gt; sayHelloWithRoleUserAndUpdateAuthority() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ResponseEntity.ok(&quot;Hello, you have access to a protected resource that requires user role and update authority.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>L&#x27;annotation <code>@PreAuthorize</code> est une fonctionnalité de Spring Security qui permet de sécuriser l&#x27;accès aux méthodes en utilisant des expressions basées sur le langage d&#x27;expression (SpEL). Cette annotation peut être appliquée au niveau de la méthode ou au niveau de la classe.</p>
<p>En utilisant <code>@PreAuthorize</code>, vous pouvez spécifier les règles de sécurité qui doivent être satisfaites pour accéder à une méthode. Les expressions SpEL fournissent une syntaxe expressive pour décrire les autorisations requises, telles que <code>hasAuthority</code>, <code>hasRole</code>, <code>hasAnyRole</code>, <code>hasPermission</code>, etc. Ces expressions peuvent faire référence aux informations sur l&#x27;utilisateur actuellement authentifié, comme ses rôles, ses autorisations et d&#x27;autres attributs.</p>
<p>L&#x27;application de l&#x27;annotation <code>@PreAuthorize</code> au niveau de la méthode signifie que la règle de sécurité s&#x27;applique uniquement à cette méthode spécifique. En revanche, l&#x27;application de l&#x27;annotation au niveau de la classe signifie que la règle de sécurité s&#x27;applique à toutes les méthodes de la classe.</p>
<p>Pour comprendre comment Spring gère cela en interne, comme je l&#x27;ai déjà expliqué, une fois l&#x27;authentification réussie, un objet de type <code>Authentication</code> est stocké dans le <code>SecurityContext</code>. Comme je vous l&#x27;ai également montré précédemment, cet objet <code>Authentication</code> contient les autorités de l&#x27;utilisateur connecté, c&#x27;est-à-dire les informations sur les rôles et les privilèges qu&#x27;il possède.</p>
<p>Le filtre <code>AuthorizationFilter</code> est le dernier filtre dans la chaîne de filtres de Spring Security. C&#x27;est la responsabilité de ce filtre d&#x27;autoriser ou non l&#x27;accès aux méthodes des contrôleurs, ainsi que de bloquer l&#x27;accès et de lever une exception en cas d&#x27;accès non autorisé. Le <code>AuthorizationFilter</code> intervient après les filtres d&#x27;authentification et évalue les autorisations nécessaires en fonction des règles de sécurité configurées. Ainsi, il prend une décision finale concernant l&#x27;autorisation et bloque l&#x27;accès si nécessaire.</p>
<p>Quand une exception d&#x27;authentification <code>AuthenticationException</code>, le filtre <code>ExceptionTranslationFilter</code>  va lancer l&#x27;<code>AuthenticationEntryPoint</code></p>
<p>L&#x27;implémentation par défaut de l&#x27;interface <code>AuthenticationEntryPoint</code> dans Spring Security est la classe <code>Http403ForbiddenEntryPoint</code>. Cette classe est utilisée par défaut pour gérer les exceptions d&#x27;authentification et renvoyer une réponse avec le code d&#x27;état HTTP 403 (Accès refusé).</p>
<p>La classe <code>Http403ForbiddenEntryPoint</code> implémente la méthode <code>commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</code> de l&#x27;interface <code>AuthenticationEntryPoint</code>. Dans cette méthode, elle configure la réponse HTTP avec le code d&#x27;état 403 et un message d&#x27;erreur standard indiquant l&#x27;accès refusé.</p>
<p>Voici la classe <code>Http403ForbiddenEntryPoint</code> fournis par Spring</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Http403ForbiddenEntryPoint implements AuthenticationEntryPoint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	private static final Log logger = LogFactory.getLog(Http403ForbiddenEntryPoint.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 * Always returns a 403 error code to the client.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException arg2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		logger.debug(&quot;Pre-authenticated entry point called. Rejecting access&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		response.sendError(HttpServletResponse.SC_FORBIDDEN, &quot;Access Denied&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="réponses-http--403-forbidden-vs-401-unauthorized">Réponses HTTP : 403 Forbidden vs 401 Unauthorized<a href="#réponses-http--403-forbidden-vs-401-unauthorized" class="hash-link" aria-label="Lien direct vers Réponses HTTP : 403 Forbidden vs 401 Unauthorized" title="Lien direct vers Réponses HTTP : 403 Forbidden vs 401 Unauthorized">​</a></h3>
<p>Il y a une distinction importante entre les codes d&#x27;état HTTP 401 Unauthorized et 403 Forbidden en ce qui concerne les erreurs d&#x27;authentification et d&#x27;autorisation.</p>
<p>Le code 401 Unauthorized est utilisé pour les erreurs d&#x27;authentification, indiquant que l&#x27;utilisateur n&#x27;est pas correctement authentifié ou doit réessayer l&#x27;authentification.  L&#x27;utilisateur doit tenter une nouvelle tentative d&#x27;authentification pour accéder à la ressource demandée.</p>
<p>Le code 403 Forbidden est utilisé pour les erreurs d&#x27;autorisation, indiquant que l&#x27;utilisateur est authentifié, mais n&#x27;est pas autorisé à accéder à la ressource demandée.</p>
<p>Pour résumer, si vous recevez une réponse avec le code 401, vous pouvez essayer une deuxième fois, mais si vous recevez une réponse avec le code 403, il est inutile d&#x27;insister. L&#x27;application vous indique simplement qu&#x27;elle vous reconnaît, mais que vous n&#x27;avez pas les droits d&#x27;accéder à la ressource, à moins que vos droits ne changent.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gérer-les-erreurs-dauthentification-avec-authenticationentrypoint">Gérer les erreurs d&#x27;authentification avec AuthenticationEntryPoint<a href="#gérer-les-erreurs-dauthentification-avec-authenticationentrypoint" class="hash-link" aria-label="Lien direct vers Gérer les erreurs d&#x27;authentification avec AuthenticationEntryPoint" title="Lien direct vers Gérer les erreurs d&#x27;authentification avec AuthenticationEntryPoint">​</a></h3>
<p>L&#x27;interface <code>AuthenticationEntryPoint</code> est utilisée pour gérer les erreurs d&#x27;authentification  (<code>AuthenticationException</code>). Comme je l&#x27;ai expliqué précédemment, lorsque un utilisateur non authentifié tente d&#x27;accéder à une ressource protégée, l&#x27;implémentation de <code>AuthenticationEntryPoint</code> est invoquée pour gérer cette situation.</p>
<p>Créez la classe <code>Http401UnauthorizedEntryPoint</code> sous le package <code>config</code> qui implémente <code>AuthenticationEntryPoint</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.databind.SerializationFeature;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.handlers.ErrorResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.ServletException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.MediaType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.AuthenticationException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.AuthenticationEntryPoint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.Instant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component @Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Http401UnauthorizedEntryPoint implements AuthenticationEntryPoint {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void commence(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.error(&quot;Unauthorized error: {}&quot;, authException.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ErrorResponse body = ErrorResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .status(HttpServletResponse.SC_UNAUTHORIZED)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .error(&quot;Unauthorized&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timestamp(Instant.now())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .message(authException.getMessage())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(request.getServletPath())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ObjectMapper mapper = new ObjectMapper();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // register the JavaTimeModule, which enables Jackson to support Java 8 and higher date and time types</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapper.registerModule(new JavaTimeModule());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ask Jackson to serialize dates as strings in the ISO 8601 format</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS,false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapper.writeValue(response.getOutputStream(), body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>La méthode <code>commence</code> est appelée lorsque l&#x27;authentification échoue et reçoit en paramètres l&#x27;objet <code>HttpServletRequest</code>, l&#x27;objet <code>HttpServletResponse</code> et l&#x27;exception <code>AuthenticationException</code>.</p>
<p><code>response.setContentType(MediaType.APPLICATION_JSON_VALUE)</code> et <code>response.setStatus(HttpServletResponse.SC_UNAUTHORIZED)</code> configurent la réponse HTTP en spécifiant le type de contenu comme JSON et le code HTTP comme 401 (Accès non autorisé)</p>
<p>L&#x27;objet <code>ErrorResponse</code>  permet d&#x27;encapsuler les détails de l&#x27;erreur.</p>
<p>Enfin,  <code>ObjectMapper</code> permet de sérialiser l&#x27;objet  <code>ErrorResponse</code>  et l&#x27;écrit dans la réponse HTTP</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gérer-les-erreurs-dautorisation-avec-accessdeniedhandler">Gérer les erreurs d&#x27;autorisation avec AccessDeniedHandler<a href="#gérer-les-erreurs-dautorisation-avec-accessdeniedhandler" class="hash-link" aria-label="Lien direct vers Gérer les erreurs d&#x27;autorisation avec AccessDeniedHandler" title="Lien direct vers Gérer les erreurs d&#x27;autorisation avec AccessDeniedHandler">​</a></h3>
<p><code>AccessDeniedHandler</code> est une interface utilisée pour gérer les erreurs d&#x27;autorisation. Lorsqu&#x27;un utilisateur authentifié tente d&#x27;accéder à une ressource pour laquelle il n&#x27;a pas les autorisations requises, nous devons alors fournir une implémentation de <code>AccessDeniedHandler</code> qui sera invoquée pour gérer cette situation</p>
<p>Le handler que nous allons créer sera utilisé par <code>ExceptionTranslationFilter</code> pour gérer une exception de type <code>AccessDeniedException</code></p>
<p>Créez la casse <code>CustomAccessDeniedHandler</code> qui implémente <code>AccessDeniedHandler</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.databind.ObjectMapper;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.databind.SerializationFeature;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.handlers.ErrorResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.ServletException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.extern.slf4j.Slf4j;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.MediaType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.access.AccessDeniedException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.access.AccessDeniedHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.time.Instant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component @Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CustomAccessDeniedHandler implements AccessDeniedHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) throws IOException, ServletException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.error(&quot;Access denied error: {}&quot;, accessDeniedException.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        response.setStatus(HttpServletResponse.SC_FORBIDDEN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ErrorResponse body = ErrorResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .status(HttpServletResponse.SC_FORBIDDEN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .error(&quot;Forbidden&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .timestamp(Instant.now())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .message(accessDeniedException.getMessage())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .path(request.getServletPath())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final ObjectMapper mapper = new ObjectMapper();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapper.registerModule(new JavaTimeModule());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS,false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mapper.writeValue(response.getOutputStream(), body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>C&#x27;est la même implémentation de <code>AuthenticationEntryPoint</code>, la seule différence est que nous avons modifié le code HTTP pour passer de 401 à 403.</p>
<p>Maintenant il nous reste de créer le filter qui va intercepter les requêtes HTTP et essayer d&#x27;authentifier l&#x27;utilisateur.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="filtrer-les-requêtes-http">Filtrer les requêtes HTTP<a href="#filtrer-les-requêtes-http" class="hash-link" aria-label="Lien direct vers Filtrer les requêtes HTTP" title="Lien direct vers Filtrer les requêtes HTTP">​</a></h3>
<p>Au début, nous avons mentionné que les requêtes demandant l&#x27;accès aux ressources protégées doivent être interceptées par un filtre personnalisé. Ce filtre tente d&#x27;authentifier l&#x27;utilisateur en se basant sur le JWT fourni. S&#x27;il réussit à authentifier l&#x27;utilisateur, il laisse ensuite la main aux autres filtres de la chaîne de filtres de Spring Security, tels que le <code>AuthorizationFilter</code>, qui prendra la décision d&#x27;autoriser ou non l&#x27;accès de l&#x27;utilisateur à la ressource.</p>
<p>Notre filtre personnalisé est une classe qui implémente <code>OncePerRequestFilter</code> qui est une classe abstraite fournie par Spring qui facilite la création de filtres pour les requêtes HTTP. Cette classe garantit que le filtre est exécuté une seule fois pour chaque requête HTTP entrante.</p>
<p>Créez la classe <code>JwtAuthenticationFilter</code> qui hérite la classe <code>OncePerRequestFilter</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.service.JwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.micrometer.common.util.StringUtils;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.FilterChain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.ServletException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletRequest;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import jakarta.servlet.http.HttpServletResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.lang.NonNull;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.context.SecurityContext;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.context.SecurityContextHolder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.web.filter.OncePerRequestFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.io.IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JwtAuthenticationFilter extends OncePerRequestFilter {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final JwtService jwtService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final UserDetailsService userDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    protected void doFilterInternal(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           @NonNull HttpServletRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           @NonNull HttpServletResponse response,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           @NonNull FilterChain filterChain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) throws ServletException, IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String authHeader = request.getHeader(&quot;Authorization&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(authHeader ==  null || !authHeader.startsWith(&quot;Bearer &quot;)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            filterChain.doFilter(request, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String jwt = authHeader.substring(7); // after &quot;Bearer &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        final String userEmail =jwtService.extractUserName(jwt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(StringUtils.isNotEmpty(userEmail)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            UserDetails userDetails = this.userDetailsService.loadUserByUsername(userEmail);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(jwtService.isTokenValid(jwt, userDetails)){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                //update the spring security context by adding a new UsernamePasswordAuthenticationToken</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SecurityContext context = SecurityContextHolder.createEmptyContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        userDetails,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        userDetails.getAuthorities());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                context.setAuthentication(authToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                SecurityContextHolder.setContext(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        filterChain.doFilter(request,response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Voici une explication détaillée du code :</p>
<ul>
<li>Le filtre vérifie si le header &quot;Authorization&quot; est présent dans la requête et commence par &quot;Bearer &quot;. S&#x27;il ne correspond pas à ces critères, le filtre laisse passer la requête sans aucune modification.</li>
<li>Si le header &quot;Authorization&quot; est présent et correspond au format &quot;Bearer &quot;, le filtre extrait le JWT de la chaîne du header.</li>
<li>À l&#x27;aide du service <code>JwtService</code>, le filtre extrait le username (email) à partir du JWT.</li>
<li>Ensuite, le filtre vérifie si le username n&#x27;est pas vide et si l&#x27;authentification n&#x27;a pas déjà été effectuée pour cette requête. Si ces conditions sont remplies, le filtre demande au service <code>userDetailsService</code> de charger les détails de l&#x27;utilisateur correspondant au nom d&#x27;utilisateur.</li>
<li>Si le service <code>userDetailsService</code> ne parvient pas à trouver l&#x27;utilisateur, une exception sera levée.</li>
<li>Le filtre utilise ensuite le service <code>JwtService</code> pour valider le JWT en le comparant aux détails de l&#x27;utilisateur chargés précédemment.</li>
<li>Si le JWT est valide, le filtre met à jour le contexte de sécurité de Spring en ajoutant une instance de <code>UsernamePasswordAuthenticationToken</code> contenant les détails de l&#x27;utilisateur authentifié.</li>
<li>Finalement, le filtre passe la requête au filtre suivant dans la chaîne de filtres en appelant <code>filterChain.doFilter(request, response)</code>.</li>
</ul>
<p>Il nous reste la dernière étape avant de tester c&#x27;est la configuration de Spring Security</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration-de-spring-security">Configuration de Spring Security<a href="#configuration-de-spring-security" class="hash-link" aria-label="Lien direct vers Configuration de Spring Security" title="Lien direct vers Configuration de Spring Security">​</a></h3>
<p>Sous le package config, commencez par créer une classe <code>ApplicationSecurityConfig</code> et ajouter l&#x27;annotation <code>@Configuration</code> pour indiquer à Spring que c&#x27;est une classe de configuration.</p>
<p>Les beans requis sont les suivants :</p>
<ol>
<li>Une implémentation de <code>UserDetailsService</code>, notamment de la méthode <code>loadByUsername</code>.</li>
<li>Une implémentation de <code>PasswordEncoder</code>, par exemple <code>BCryptPasswordEncoder</code> utilisé par défaut.</li>
<li>L&#x27;<code>AuthenticationProvider</code> utilisant <code>DaoAuthenticationProvider</code> avec l&#x27;implémentation de <code>UserDetailsService</code> et <code>PasswordEncoder</code>.</li>
<li>L&#x27;<code>AuthenticationManager</code> obtenu à partir de <code>AuthenticationConfiguration</code>.</li>
</ol>
<p>Voici la classe <code>ApplicationSecurityConfig</code> :</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import fr.mossaab.security.repository.UserRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.AuthenticationManager;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.AuthenticationProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.dao.DaoAuthenticationProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UsernameNotFoundException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.crypto.password.PasswordEncoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ApplicationSecurityConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final UserRepository userRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public UserDetailsService userDetailsService(){</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return username -&gt; userRepository.findByEmail(username)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .orElseThrow(()-&gt; new UsernameNotFoundException(&quot;User not found&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AuthenticationProvider authenticationProvider() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authProvider.setUserDetailsService(userDetailsService());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authProvider.setPasswordEncoder(passwordEncoder());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return authProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return config.getAuthenticationManager();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public PasswordEncoder passwordEncoder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new BCryptPasswordEncoder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nous allons maintenant créer la classe <code>SecurityConfiguration</code> qui responsable de configurer les règles de sécurité pour les requêtes HTTP et spécifier les filtres et les gestionnaires nécessaires pour l&#x27;authentification et les autorisations dans notre application. Elle définit également les règles d&#x27;autorisation pour les ressources de l&#x27;API</p>
<p>Dans cette classe, nous devons fournir le bean <code>SecurityFilterChain</code>, comme je l&#x27;ai expliqué et mentionné dans le diagramme d&#x27;architecture de Spring au début de cet article.</p>
<p>Créez la classe <code>SecurityConfiguration</code> avec une méthode <code>securityFilterChain</code> qui prend en paramètre <code>HttpSecurity</code> et renvoie le bean <code>SecurityFilterChain</code>.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package fr.mossaab.security.config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import lombok.RequiredArgsConstructor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Bean;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.http.HttpMethod;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.authentication.AuthenticationProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.SecurityFilterChain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import static org.springframework.security.config.http.SessionCreationPolicy.STATELESS;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableWebSecurity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableMethodSecurity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final JwtAuthenticationFilter jwtAuthenticationFilter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final AuthenticationProvider authenticationProvider;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Http401UnauthorizedEntryPoint unauthorizedEntryPoint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final CustomAccessDeniedHandler accessDeniedHandler;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        http.csrf(AbstractHttpConfigurer::disable)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .exceptionHandling(exception -&gt; exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .authenticationEntryPoint(unauthorizedEntryPoint)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        .accessDeniedHandler(accessDeniedHandler))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .authorizeHttpRequests(request -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .requestMatchers(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                        &quot;/api/v1/auth/**&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                ).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               //.requestMatchers(&quot;/api/v1/admin/resource&quot;).hasRole(&quot;ADMIN&quot;) replaced with annotation in AuthorizationController      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                .anyRequest().authenticated())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sessionManagement(manager -&gt; manager.sessionCreationPolicy(STATELESS))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .authenticationProvider(authenticationProvider).addFilterBefore(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return http.build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Voici une explique de la méthode<code>securityFilterChain()</code> :</p>
<p>Cette méthode crée un bean <code>SecurityFilterChain</code> qui définit les règles de sécurité pour les requêtes HTTP. Elle utilise la méthode de configuration <code>http</code> pour spécifier les autorisations d&#x27;accès aux ressources.</p>
<ul>
<li><code>csrf(AbstractHttpConfigurer::disable)</code>: Désactive la protection CSRF. Comme expliqué précédemment, en mode Stateless, cette protection est inutile dans notre cas.</li>
<li><code>exceptionHandling()</code>: Gère les exceptions liées à l&#x27;authentification et aux autorisations. Ici, nous avons spécifié les deux implémentations que nous avons créées, <code>CustomAccessDeniedHandler</code> et <code>Http401UnauthorizedEntryPoint</code>.</li>
<li><code>authorizeHttpRequests()</code>: Définit les règles d&#x27;autorisation pour les requêtes HTTP. Dans notre cas, l&#x27;accès est autorisé pour les requêtes vers &quot;/api/v1/auth/**&quot;, qui est le chemin d&#x27;accès vers notre contrôleur d&#x27;authentification, et nécessite une authentification pour toutes les autres requêtes.</li>
<li><code>sessionManagement()</code>: Définit la gestion des sessions en mode Stateless, où la création de session est désactivée.</li>
<li><code>authenticationProvider()</code>: Spécifie l&#x27;<code>AuthenticationProvider</code> utilisé pour l&#x27;authentification, fourni par notre classe <code>ApplicationSecurityConfig</code> que nous venons de créer.</li>
<li><code>addFilterBefore()</code>: Ajoute notre filtre personnalisé <code>JwtAuthenticationFilter</code> avant le <code>UsernamePasswordAuthenticationFilter</code> pour gérer l&#x27;authentification basée sur le JWT.</li>
</ul>
<p>Ces configurations permettent de définir les règles de sécurité de notre application Spring Security en désactivant CSRF, gérant les exceptions, spécifiant les autorisations d&#x27;accès et la gestion des sessions, ainsi que l&#x27;ajout de notre filtre personnalisé pour l&#x27;authentification basée sur le JWT.</p>
<p>Les règles d&#x27;autorisation sont gérées à l&#x27;aide des annotations directement au niveau des contrôleurs, c&#x27;est pourquoi nous avons ajouté l&#x27;annotation <code>@EnableMethodSecurity</code>. Cependant, vous avez également la possibilité de gérer les autorisations de manière globale dans le bean <code>SecurityFilterChain</code> en utilisant les <code>requestMatchers</code>. Par exemple, vous pouvez spécifier que l&#x27;accès à &quot;/api/v1/admin/resource&quot; nécessite le rôle &quot;ADMIN&quot; avec <code>.requestMatchers(&quot;/api/v1/admin/resource&quot;).hasRole(&quot;ADMIN&quot;)</code>. De même, vous pouvez autoriser uniquement la méthode HTTP POST sur certaines URL en utilisant <code>.requestMatchers(HttpMethod.POST,&quot;/api/v1/admin/resource&quot;).hasRole(&quot;ADMIN&quot;)</code>. Cette approche vous permet de gérer les autorisations de manière plus granulaire en spécifiant les URL et les méthodes HTTP associées aux autorisations requises.</p>
<p>Il est important de noter que Spring Security offre de nombreuses possibilités de personnalisation. Je vous encourage à explorer la documentation officielle pour en savoir plus. Cependant, la configuration que nous avons mise en place est suffisante pour notre API.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="démonstration-de-lapplication">Démonstration de l&#x27;application<a href="#démonstration-de-lapplication" class="hash-link" aria-label="Lien direct vers Démonstration de l&#x27;application" title="Lien direct vers Démonstration de l&#x27;application">​</a></h2>
<p>Avant de tester l&#x27;application, voici notre fichier <code>application.yml</code> (vous pouvez également utiliser <code>application.properties</code>) :</p>
<div class="language-yml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datasource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">driver-class-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.postgresql.Driver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jdbc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">postgresql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5432/db_security</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">POSTGRES_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">jpa</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hibernate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">ddl-auto</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">show-sql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">properties</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hibernate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">format_sql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">database</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgresql</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">database-platform</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> org.hibernate.dialect.PostgreSQLDialect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8086</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">application</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">security</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">jwt</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">secret-key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 586B633834416E396D7436753879382F423F4428482B4C6250655367566B5970</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">expiration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">86400000</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># a day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">refresh-token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">expiration</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">604800000</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 7 days</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copier le code" title="Copier" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Nous allons maintenant tester l&#x27;accès à notre application en utilisant  <code>Postman</code> qui est une application permettant de tester des API</p>
<p><strong>L&#x27;ajout de deux utilisateurs, l&#x27;un avec le rôle USER et l&#x27;autre avec le rôle ADMIN</strong></p>
<p><img decoding="async" loading="lazy" alt="admin-register" src="/assets/images/admin-register-617bf0d4fefc0a68804bf1aa948c0931.PNG" width="842" height="715" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="register" src="/assets/images/register-cb2c100fa1454dfb6e392c188a79414d.PNG" width="738" height="680" class="img_ev3q"></p>
<p><strong>L&#x27;authentification d&#x27;un utilisateur</strong></p>
<p><img decoding="async" loading="lazy" alt="user_auth" src="/assets/images/user_auth-413adee9bb1bf09d8026a0d46eae26af.PNG" width="743" height="610" class="img_ev3q"></p>
<p>**Échec de l&#x27;authentification **</p>
<p><img decoding="async" loading="lazy" alt="invalid-email" src="/assets/images/invalid-email-44f5c37bbd481a4e6f58063daac0c4e5.PNG" width="626" height="605" class="img_ev3q"></p>
<p><strong>L&#x27;accès à une ressource protégée qui nécessite un JWT valide</strong></p>
<p>L&#x27;utilisateur doit avoir le rôle admin avec le droit de lecture :</p>
<p><img decoding="async" loading="lazy" alt="admin-access-protected" src="/assets/images/admin-access-protected-da088384de62cdd5c6c696f1ec8dab78.PNG" width="842" height="434" class="img_ev3q"></p>
<p>Si nous essayons d&#x27;accéder à la même ressource, mais cette fois avec le JWT de l&#x27;utilisateur ayant le rôle USER :</p>
<p><img decoding="async" loading="lazy" alt="forbidden-user-admin" src="/assets/images/forbidden-user-admin-25e7ff246ae0a0efaa6be11238b75ed7.png" width="843" height="535" class="img_ev3q"></p>
<p><strong>L&#x27;accès L&#x27;accès à une ressource protégée avec un JWT expiré :</strong></p>
<p><img decoding="async" loading="lazy" alt="user-jwt-expired" src="/assets/images/user-jwt-expired-c4fbf4991963f4e648cabf1844b34dc9.PNG" width="835" height="531" class="img_ev3q"></p>
<p><strong>Demander un nouveau JWT à partir d&#x27;un refreshToken valide :</strong></p>
<p><img decoding="async" loading="lazy" alt="user-refreshtoken" src="/assets/images/user-refreshtoken-4dc9c5b900818dd1e501bfa6a22e8f54.PNG" width="841" height="548" class="img_ev3q"></p>
<p><strong>Demander un nouveau JWT à partir d&#x27;un refreshToken invalide :</strong></p>
<p><img decoding="async" loading="lazy" alt="invalidRefreshToken" src="/assets/images/invalidRefreshToken-0d6be915a34847c31d1b95cb6390b816.PNG" width="844" height="555" class="img_ev3q"></p>
<p><strong>Demander un nouveau JWT à partir d&#x27;un refreshToken expiré :</strong></p>
<p><img decoding="async" loading="lazy" alt="expired-refreshtoken" src="/assets/images/expired-refreshtoken-a5db229a0ad2ad207576097a8d3fdc20.PNG" width="844" height="598" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Lien direct vers Conclusion" title="Lien direct vers Conclusion">​</a></h2>
<p>Cet article nous a présenté l&#x27;utilisation de Spring Security pour sécuriser une application Spring Boot. Nous avons exploré divers concepts tels que l&#x27;authentification, l&#x27;autorisation et l&#x27;utilisation de JWT. Grâce à Spring Security, nous avons pu mettre en place une couche de sécurité robuste pour protéger nos ressources et gérer les droits d&#x27;accès des utilisateurs.</p>
<p>Le code complet de l&#x27;implémentation présentée dans cet article est disponible sur <a href="https://github.com/MossaabFrifita/spring-boot-3-security-6-jwt" target="_blank" rel="noopener noreferrer">GitHub</a></p>
<p>En utilisant les principes de Spring Security et en comprenant ses fonctionnalités clés, vous pouvez renforcer la sécurité de votre application et protéger les ressources sensibles contre les accès non autorisés.</p>
<p>N&#x27;oubliez pas de toujours garder à l&#x27;esprit les meilleures pratiques de sécurité lors du développement d&#x27;applications et de continuer à vous informer sur les nouvelles tendances et les mises à jour de Spring Security pour maintenir votre application sécurisée.</p>
<p>Soyez assuré que Spring Security offre une solution puissante et flexible pour répondre à vos besoins de sécurité, et il reste un choix populaire pour sécuriser les applications basées sur Spring Boot.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags :</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/spring-security">SpringSecurity</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/jwt">JWT</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/refresh-token">RefreshToken</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/authentification">Authentification</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/autorisation">Autorisation</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/securite-web">SécuritéWeb</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/spring">Spring</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/spring-boot">SpringBoot</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/java">Java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/docs/tags/api">api</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Pages de documentation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/category/spring-framework"><div class="pagination-nav__sublabel">Précédent</div><div class="pagination-nav__label">Spring Framework</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/category/angular"><div class="pagination-nav__sublabel">Suivant</div><div class="pagination-nav__label">Angular</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#focus-sur-lauthentification" class="table-of-contents__link toc-highlight">Focus sur l&#39;authentification</a><ul><li><a href="#authentification-stateful" class="table-of-contents__link toc-highlight">Authentification Stateful</a></li><li><a href="#authentification-stateless" class="table-of-contents__link toc-highlight">Authentification Stateless</a></li></ul></li><li><a href="#focus-sur-lautorisation" class="table-of-contents__link toc-highlight">Focus sur l&#39;autorisation</a></li><li><a href="#lutilisation-dun-jwt" class="table-of-contents__link toc-highlight">L’utilisation d’un JWT</a></li><li><a href="#lutilisation-dun-refreshtoken" class="table-of-contents__link toc-highlight">L&#39;utilisation d&#39;un refreshToken</a></li><li><a href="#comprendre-le-mécanisme-de-lauthentification-et-lautorisation" class="table-of-contents__link toc-highlight">Comprendre le mécanisme de l&#39;authentification et l&#39;autorisation</a><ul><li><a href="#authentification-dun-utilisateur" class="table-of-contents__link toc-highlight">Authentification d&#39;un utilisateur</a></li><li><a href="#demander-une-ressource-nécessitant-lauthentification" class="table-of-contents__link toc-highlight">Demander une ressource nécessitant l&#39;authentification</a></li><li><a href="#les-endpoints" class="table-of-contents__link toc-highlight">Les endpoints</a></li><li><a href="#initialisation-du-projet" class="table-of-contents__link toc-highlight">Initialisation du projet</a></li><li><a href="#création-des-énumérations" class="table-of-contents__link toc-highlight">Création des énumérations</a></li><li><a href="#création-de-lentité-user" class="table-of-contents__link toc-highlight">Création de l&#39;entité User</a></li><li><a href="#création-de-lentité-refreshtoken" class="table-of-contents__link toc-highlight">Création de l&#39;entité RefreshToken</a></li><li><a href="#création-des-repositories-user-et-refreshtoken" class="table-of-contents__link toc-highlight">Création des Repositories User et RefreshToken</a></li><li><a href="#définition-des-payloads" class="table-of-contents__link toc-highlight">Définition des payloads</a></li><li><a href="#implémentation-du-service-jwtservice" class="table-of-contents__link toc-highlight">Implémentation du Service JwtService</a></li><li><a href="#implémentation-du-service-authenticationservice" class="table-of-contents__link toc-highlight">Implémentation du Service AuthenticationService</a></li><li><a href="#implémentation-du-service-refreshtokenservice" class="table-of-contents__link toc-highlight">Implémentation du Service RefreshTokenService</a></li><li><a href="#gestion-des-exceptions" class="table-of-contents__link toc-highlight">Gestion des exceptions</a></li><li><a href="#création-des-contrôleurs-rest" class="table-of-contents__link toc-highlight">Création des contrôleurs Rest</a></li><li><a href="#réponses-http--403-forbidden-vs-401-unauthorized" class="table-of-contents__link toc-highlight">Réponses HTTP : 403 Forbidden vs 401 Unauthorized</a></li><li><a href="#gérer-les-erreurs-dauthentification-avec-authenticationentrypoint" class="table-of-contents__link toc-highlight">Gérer les erreurs d&#39;authentification avec AuthenticationEntryPoint</a></li><li><a href="#gérer-les-erreurs-dautorisation-avec-accessdeniedhandler" class="table-of-contents__link toc-highlight">Gérer les erreurs d&#39;autorisation avec AccessDeniedHandler</a></li><li><a href="#filtrer-les-requêtes-http" class="table-of-contents__link toc-highlight">Filtrer les requêtes HTTP</a></li><li><a href="#configuration-de-spring-security" class="table-of-contents__link toc-highlight">Configuration de Spring Security</a></li></ul></li><li><a href="#démonstration-de-lapplication" class="table-of-contents__link toc-highlight">Démonstration de l&#39;application</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/category/devops-cicd-pipeline">Articles</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.linkedin.com/in/mossaab-frifita-17ba44138" target="_blank" rel="noopener noreferrer" class="footer__link-item">LinkedIn<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/MossaabFrifita" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Mossaab Frifita. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>